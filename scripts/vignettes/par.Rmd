---
title: "Grid search for <span>\\( \\phi \\)</span>-values"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
root <- rprojroot::find_root(rprojroot::has_dir(".git"))
r_dir <- file.path(root, "r-utils")
invisible(lapply(list.files(r_dir, full.names = TRUE, recursive = TRUE),
                 source))
tex <- latex2exp::TeX
set.seed(2024)

# load data
dat_lst <- real_data()
k <- 11
nboot <- 50
samp <- TRUE
R <- dat_lst$R[samp, seq_len(k)]
X <- dat_lst$X[samp]
Y <- dat_lst$Y[samp]
```

We first look at possible agnostic, $x$-specific, and $y$-specific $\phi$-values. In particular, over a range of values of $\phi$, and grids of values of $(\phi_{x_0}, \phi_{x_1})$ and $(\phi_{y_0}, \phi_{y_1})$ we estimate the effects 
\begin{align}
  &\text{ATE}_{x_0, x_1}(y \mid \Phi = (\phi, \phi,\phi,\phi)), \\
  &\text{ATE}_{x_0, x_1}(y \mid \Phi = (\phi_{x_0}, \phi_{x_1},\phi_{x_0},\phi_{x_1})), \\
  &\text{ATE}_{x_0, x_1}(y \mid \Phi = (\phi_{y_0}, \phi_{y_0},\phi_{y_1},\phi_{y_1})),
\end{align}
based on the two stage EM approach.

```{r main, fig.align='center', fig.width=12, fig.height=4, fig.cap="Estimation of ATE values based on the two-stage EM approach.", fig.width=18, fig.height=4}
fi_seq <- seq(0, 0.2, 0.05)
fi_grid <- rbind(
  rng_to_df("agnostic", fi_seq),
  rng_to_df("x", fi_seq, fi_seq),
  rng_to_df("y", fi_seq, fi_seq)
)

fi_grid <- grid_search(fi_grid, "two-stage-em")
grid_multi_plt(fi_grid, "two-stage-em")
```

```{r x-grid-save, echo=FALSE}
ggsave(file.path(root, "paper", "figures", "par-agn-x-y.png"), 
       width = 18, height = 4)
```

As the above plots demonstrate, the only possible $\phi$-value that would plausibly reverse the sign of the causal effect estimate in the data seems to be $x$-specific, in the direction of $\phi_{x_1} = 0$ and $\phi_{x_0}$ increasing.
We next run the sensitivity analysis along this direction over multiple bootstrap repetitions, to also obtain valid confidence intervals for the possible values of ATE$_{x_0, x_1}(y \mid \Phi)$.

## $x$-specific $\phi$-value with Uncertainty Quantification

```{r, axis-search-ci, fig.align='center', , fig.cap="Estimation of the ATE based on the two-stage EM approach, x-specific in the direction of increasing missingness for X = 0."}
fi_seq <- subset(fi_grid, type == "x" & fi_x1y1 == 0)$fi_x0y1

axs_dat <- axis_search(X, Y, R, fi_seq, type = "x", solver = "two-stage-em",
                       nboot = nboot)[["df"]]

ggplot(axs_dat, aes(x = fi, y = mid)) +
  geom_hline(yintercept = 0, color = "gray", 
             linetype = "dotted", linewidth = 1) +
  geom_point() + geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.3) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +
  xlab(tex("$\\phi_{x_0}")) +
  ylab(tex("ATE$_{x_0, x_1}(y ; \\Phi = (\\phi_{x_0}, 0, \\phi_{x_0}, 0))$"))
```

```{r x-axis-ci, echo=FALSE}
ggsave(file.path(root, "paper", "figures", "par-x-axis-ci.png"), 
       width = 6, height = 4)
```

Importantly, in this analysis, we find that a $\phi$-value of $(\phi_{x_0}, \phi_{x_1}) = (0.1, 0)$ would explain away the positive causal effect estimate of obesity on survival.
In the final part of the experiment, we establish whether our inference method can be trusted, by applying it to a model with a known ground truth.


## Verification on Known Ground Truth
In the sequel, we investigate the performance of our inference method along this direction applied to data from a known ground truth model. In particular, we first infer the parameters of the matrix $\Sigma$ assuming that $\Phi = (0, 0, 0, 0)$ is the true value.

```{r infer-Sigma}
# infer the Sigma assuming \Phi = (0, 0, 0, 0)
Sigma_mim0 <- binsensate:::infer_Sigma(
  X, Y, R, fi = list(list(0, 0), list(0, 0))
)
```

Then, we further infer the coefficients of $Z \to X$ (labeled $\lambda$), $Z \to Y$ (labeled $\mu$) again assuming $\Phi = (0, 0, 0, 0)$ is the true value. 

```{r infer-lambda-mu}
# infer the Z coefficients at X, Y
lambda <- glm(X ~ ., data = data.frame(X, R), family = "binomial")$coef
mu <- glm(Y ~ ., data = data.frame(Y, X, R), family = "binomial")$coef[-2]
mu_mod <- glm(Y ~ ., data = data.frame(Y, X, R), family = "binomial")
```

Now, for each value of $(\phi_{x_1}, \phi_{x_0})$ with $\phi_{x_0} \in \{0, 0.05, 0.1, 0.15, 0.2\}$ and $\phi_{x_1} = 0$, we pick the value of $\beta(\phi_{x_1}, \phi_{x_0})$ that generates exactly the same ATE as was obtained for $\text{ATE}_{x_0, x_1}(y \mid \Phi = (\phi_{x_0}, \phi_{x_1},\phi_{x_0},\phi_{x_1}))$.

```{r search-beta}
ate_to_or <- function(ate, mu_mod, R) {
  
  logits <- predict(mu_mod, data.frame(X = 0, R))
  
  a <- -0.5
  b <- 0.5
  while (b - a > 0.0005) {
    
    beta <- (b+a) / 2
    ate_b <- mean(expit(logits + beta) - expit(logits))
    
    if (ate_b > ate) b <- beta else a <- beta
  }
  
  (b+a) / 2
}
```

```{r x-axis-search}
fi_seq <- subset(fi_grid, type == "x" & fi_x1y1 == 0)$fi_x0y1
ate_seq <- subset(fi_grid, type == "x" & fi_x1y1 == 0)$ate

ate_seq <- ate_seq[order(fi_seq)]
fi_seq <- fi_seq[order(fi_seq)]

Xsim <- Ysim <- Rsim <- list()
for (i in seq_along(fi_seq)) {
  
  dat_sim <- synth_data_mid(
        n = nrow(R), k = nrow(Sigma_mim0),
        fi = list(list(fi_seq[i], fi_seq[i]), list(0, 0)),
        class = "expfam-2d",
        Sigma = Sigma_mim0, lam = lambda[-1], mu = mu[-1],
        icept_x = lambda[1], icept_y = mu[1],
        beta = ate_to_or(ate_seq[i], mu_mod, R)
      )
  
  Xsim[[i]] <- dat_sim$X
  Ysim[[i]] <- dat_sim$Y
  Rsim[[i]] <- dat_sim$R
}

plot_dat <- axis_search(Xsim, Ysim, Rsim, fi_seq, "x", "two-stage-em",
                        nboot = nboot)[["df"]]
```


Finally, after performing inference with a known ground truth, we can check the correctness.

```{r check-correctness, fig.align='center', fig.cap="Estimation of the ATE based on the two-stage EM approach, x-specific in the direction of increasing missingness for X = 0, for a model with a known ground truth."}
# get the ground truth
df <- data.frame(fi = fi_seq, smooth = ate_seq)

# check the correctness of inference
ggplot(plot_dat, aes(x = fi, y = mid)) +
  geom_hline(yintercept = 0, color = "gray", 
             linetype = "dotted", linewidth = 1) +
  geom_line(aes(color = "Estimated")) + 
  geom_point(aes(color = "Estimated")) +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              linewidth = 0, alpha = 0.2) +
  theme_bw() +
  geom_point(data = df, aes(x = fi, y = smooth, color = "Ground Truth")) +
  geom_line(data = df, aes(x = fi, y = smooth, color = "Ground Truth")) +
  scale_color_manual(
    name = "Quantity",
    values = c("black", "red"), 
    labels = c("Estimated", "Ground Truth")
  ) +
  theme(
    legend.position = c(0.25, 0.8),
    legend.box.background = element_rect()
  ) +
  xlab(tex("$\\phi_{x_0}")) +
  scale_y_continuous(labels = scales::percent) +
  ylab(tex("ATE$_{x_0, x_1}(y ; \\Phi = (\\phi_{x_0}, 0, \\phi_{x_0}, 0))$"))
```

```{r x-axis-ground-truth, echo=FALSE}
ggsave(file.path(root, "paper", "figures", "par-ground-truth.png"), 
       width = 6, height = 4)
```

The shaded area represents the 95\% confidence intervals obtained using bootstrap. As can be seen, our method performs reasonably well in capturing the ground truth effect estimates at different values of $\Phi$.